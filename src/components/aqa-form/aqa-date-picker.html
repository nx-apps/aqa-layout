<link rel="import" href="../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">

<link rel="import" href="./aqa-date-picker-light.html">
<link rel="import" href="../aqa-font/aqa-trirong-font.html">
<link rel="import" href="./aqa-date-icon.html">

<dom-module id="aqa-date-picker">
  <template>
    <style>
      .container{
        position: relative;
      }
      .container > iron-icon{
        position: absolute;
        bottom: 6px;
        right: 6px;
      }
    </style>
    <div class="container">
      <slot id="slot"></slot>
      <iron-icon icon="aqa-data-icon:calendar" on-click="_iconClick"></iron-icon>
    </div>
    
  </template>

  <script>

    class AqaDatePicker extends Polymer.mixinBehaviors([Polymer.IronValidatorBehavior], Polymer.Element) {

      static get is() { return 'aqa-date-picker'; }

      constructor(){
        super()
        
        if(!window.aqaDataPickerSection){
          window.aqaDataPickerSection = document.createElement('aqa-date-picker-light')
          window.aqaDataPickerSection.id = "aqaDataPickerLight"
          document.querySelector('body').appendChild(window.aqaDataPickerSection)
        }
        
      }

      connectedCallback(){
        super.connectedCallback()
        setTimeout(()=>{
          
          this.child = this.children[0]
          this.child.type = "date"
          
          this.nativeInput = this.child.$.nativeInput
          this.nativeInput.addEventListener('focus',this._showDatePicker.bind(this))
          this.nativeInput.addEventListener('blur',this._hideDatePicker.bind(this))

          this.aqaDataPickerLight = document.getElementById('aqaDataPickerLight')
          this.calendar = aqaDataPickerLight.$.calendar       

        },1)
        
      }

      _iconClick(){
        this.nativeInput.focus()
      }

      _showDatePicker(){
        
        this.child.addEventListener('value-changed',this._childValueChanged.bind(this))

        this.aqaDataPickerLight.child = this.child

        this.calendar.style.display = "block"
        var bodyHeight = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight
        
        var offsetChild = this.child.getBoundingClientRect()
        var offsetCalendar = this.calendar.getBoundingClientRect()

        if(
          (bodyHeight - (offsetChild.top+offsetChild.height)) > offsetCalendar.height
        ){
          this.calendar.style.left = (offsetChild.left+offsetChild.width-offsetCalendar.width)+'px';
          this.calendar.style.top = (offsetChild.top+offsetChild.height)+'px';
        }else{
          this.calendar.style.left = (offsetChild.left+offsetChild.width-offsetCalendar.width)+'px';
          this.calendar.style.top = (offsetChild.top-offsetCalendar.height)+'px';
        }
        
      }

      _hideDatePicker(){
        setTimeout(()=>{
          this.calendar.style.display = "none"
        },100)
        
      }

      _childValueChanged(e){
        var value = e.target.value
        var valueInput = "";

        valueInput += value.substring(0, 2)
        if (value.length > 2) {
            valueInput += '/'
        }
        valueInput += value.substring(2, 4)
        if (value.length > 4) {
            valueInput += '/'
        }
        valueInput += value.substring(4, 8)

        // console.log(this.aqaDataPickerLight.selectBe)
        this.aqaDataPickerLight.selectedBe = valueInput
      }



    }

    window.customElements.define(AqaDatePicker.is, AqaDatePicker);
  </script>
</dom-module>